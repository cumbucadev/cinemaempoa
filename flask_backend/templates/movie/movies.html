{% extends "base.html" %}
<style>
    .grid-item {
        width: 325px;
    }

    .poster-container {
        position: relative !important;
        display: inline-block !important;
        cursor: pointer !important;
        width: 325px !important;
        overflow: visible !important;
        line-height: 0 !important;
    }

    .poster-container img {
        width: 100%;
        height: auto;
        display: block;
        vertical-align: top;
        position: relative;
        z-index: 1;
    }

    .download-overlay {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        top: auto !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        background: transparent !important;
        border-radius: 50% !important;
        width: 44px !important;
        height: 44px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 99999 !important;
        pointer-events: auto !important;
        transform: translateX(0) !important;
    }

    .poster-container:hover .download-overlay {
        opacity: 1;
    }

    .download-btn {
        color: white !important;
        text-decoration: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        transition: all 0.2s ease !important;
    }

    .download-btn:hover {
        color: white !important;
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .download-btn svg {
        width: 28px;
        height: 28px;
        filter: drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 2px 6px rgba(0, 0, 0, 0.9));
    }

    .poster-container .download-overlay {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        top: auto !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 44px !important;
        height: 44px !important;
        background: transparent !important;
        border-radius: 50% !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: auto !important;
    }

    .poster-container:hover .download-overlay {
        opacity: 1 !important;
    }

    .poster-container .download-btn {
        color: white !important;
        text-decoration: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        transition: all 0.2s ease !important;
    }

    /* Força o posicionamento mesmo com CSS externo */
    .poster-container .download-overlay[style*="position: absolute"] {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        top: auto !important;
        z-index: 999999 !important;
    }

    /* Classe específica para sobrescrever CSS do Halfmoon */
    .poster-container .download-overlay.download-overlay-forced {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        top: auto !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 44px !important;
        height: 44px !important;
        background: transparent !important;
        border-radius: 50% !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: auto !important;
    }

    .poster-container:hover .download-overlay.download-overlay-forced {
        opacity: 1 !important;
    }

    .poster-container .download-btn.download-btn-forced {
        color: white !important;
        text-decoration: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        transition: all 0.2s ease !important;
    }

    /* Força o posicionamento com especificidade máxima */
    .poster-container .download-overlay.download-overlay-forced[style*="position: absolute"] {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        top: auto !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 44px !important;
        height: 44px !important;
        background: transparent !important;
        border-radius: 50% !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: auto !important;
    }

    .poster-container:hover .download-overlay.download-overlay-forced[style*="position: absolute"] {
        opacity: 1 !important;
    }

    /* CSS final para forçar posicionamento */
    .poster-container .download-overlay {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        top: auto !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 44px !important;
        height: 44px !important;
        background: transparent !important;
        border-radius: 50% !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: auto !important;
    }

    .poster-container:hover .download-overlay {
        opacity: 1 !important;
    }

    .poster-container .download-btn {
        color: white !important;
        text-decoration: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        transition: all 0.2s ease !important;
    }

    /* Solução alternativa usando transform */
    .download-overlay-fixed {
        position: absolute !important;
        transform: translate(calc(100% - 47px), calc(100% - 54px)) !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 44px !important;
        height: 44px !important;
        background: transparent !important;
        border-radius: 50% !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: auto !important;
    }

    .poster-container:hover .download-overlay-fixed {
        opacity: 1 !important;
    }

    /* JavaScript vai forçar o posicionamento */
    .download-overlay-js {
        position: absolute !important;
        z-index: 999999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 44px !important;
        height: 44px !important;
        background: transparent !important;
        border-radius: 50% !important;
        opacity: 0 !important;
        transition: opacity 0.3s ease !important;
        pointer-events: auto !important;
    }

    .poster-container:hover .download-overlay-js {
        opacity: 1 !important;
    }
</style>
{% block header %}
    <h1>
        {% block title %}
            Posters
        {% endblock title %}
    </h1>
    <p>Diferentes formas de visualizar os posters de filmes que já passaram pelo cinemaempoa.</p>
    <!-- Pills -->
    <nav class="navbar mb-3">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link active"
                   aria-current="true"
                   href="{{ url_for("movie.posters") }}">Mosaico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for("movie.posters_cubism") }}">Cubismo</a>
            </li>
        </ul>
    </nav>
{% endblock header %}
{% block content %}
    <section class="grid">
        {% include "movie/movie_posters.html" %}
    </section>
    <script>
        let masonry, observer, currPage = -1;

        async function intersectionCallback(entries, _observer) {
            const entry = entries[0];
            if (entries[0].intersectionRatio <= 0) {
                return;
            }
            const currentImage = entry.target;
            const section = document.querySelector("section.grid");

            _observer.unobserve(currentImage);
            currentImage.setAttribute("data-observed", 0);

            const nextPage = parseInt(currPage) + 1;

            const nextPageFetch = await fetch(
                `/movies/posters/images?page=${nextPage}`, {
                    headers: {
                        "X-LAZY-LOAD": "1"
                    }
                }
            )

            if (!nextPageFetch.ok) {
                if (nextPageFetch.status && nextPageFetch.status == 404) {
                    // register that someone scrolled to the bottom of the page
                    // using a goatcounter event
                    if (window.goatcounter) {
                        window.goatcounter.count({
                            path: window.location.pathname,
                            title: "Posters loaded last page",
                            event: true,
                        });
                    }
                }
                return;
            }

            currPage += 1;

            const nextPageText = await nextPageFetch.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(nextPageText, 'text/html');
            const nextPageContainers = doc.querySelectorAll(".poster-container.grid-item");

            section.setAttribute('data-page', nextPage);
            nextPageContainers.forEach((container) => section.appendChild(container));
            masonry.appended(nextPageContainers);

            const containersObserver = Array.from(section.getElementsByClassName('poster-container'));
            const lastContainer = containersObserver[containersObserver.length - 1];
            lastContainer.setAttribute("data-observed", 1);
            _observer.observe(lastContainer);
            // register that someone scrolled up to the next page
            // using a goatcounter event
            if (window.goatcounter) {
                window.goatcounter.count({
                    path: window.location.pathname,
                    title: "Posters load next page",
                    event: true,
                });
            }
        }

        function removeOnError(e) {
            const img = e.target;
            const container = img.closest('.poster-container');
            const isObserved = container.getAttribute("data-observed");
            container.remove();
            if (isObserved) {
                const containers = Array.from(document.querySelectorAll("section.grid .poster-container"));
                const lastContainer = containers[containers.length - 1];
                observer.observe(lastContainer);
                lastContainer.setAttribute("data-observed", 1);
            }
            masonry.layout();
        }


        // Função para carregar uma nova página de imagens
        async function fetchNextPage() {
            const section = document.querySelector("section.grid");
            const nextPage = parseInt(currPage) + 1;

            const nextPageFetch = await fetch(`/movies/posters/images?page=${nextPage}`, {
                headers: {
                    "X-LAZY-LOAD": "1"
                }
            });

            if (!nextPageFetch.ok) {
                return;
            }

            currPage += 1;

            const nextPageText = await nextPageFetch.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(nextPageText, 'text/html');
            const nextPageContainers = doc.querySelectorAll(".poster-container.grid-item");

            section.setAttribute('data-page', nextPage);
            nextPageContainers.forEach((container) => section.appendChild(container));
            masonry.appended(nextPageContainers);
        }

        document.addEventListener("DOMContentLoaded", async (event) => {
            const grid = document.querySelector('main');
            masonry = new Masonry(grid, {
                // options
                itemSelector: '.grid-item',
                columnWidth: 325
            });
            imagesLoaded(grid).on('progress', function() {
                masonry.layout();
            });

            // Chamada inicial para carregar as primeiras imagens
            await fetchNextPage();

            observer = new IntersectionObserver(intersectionCallback, {
                threshold: 1
            });
            const containers = Array.from(document.querySelectorAll(".poster-container.grid-item"));
            if (containers.length > 0) {
                observer.observe(containers[containers.length - 1]);
            }

            // Força o posicionamento dos botões de download
            function positionDownloadButtons() {
                const downloadOverlays = document.querySelectorAll('.download-overlay-js');
                downloadOverlays.forEach(overlay => {
                    const container = overlay.closest('.poster-container');
                    if (container) {
                        const rect = container.getBoundingClientRect();
                        overlay.style.position = 'absolute';
                        overlay.style.bottom = '10px';
                        overlay.style.right = '3px';
                        overlay.style.left = 'auto';
                        overlay.style.top = 'auto';
                        overlay.style.zIndex = '999999';
                    }
                });
            }

            // Executa após o layout do Masonry
            setTimeout(positionDownloadButtons, 100);

            // Observa mudanças no layout
            const layoutObserver = new MutationObserver(positionDownloadButtons);
            layoutObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
    </script>
    <script src="{{ url_for('static', filename='imagesLoaded.js') }}"></script>
    <script src="{{ url_for('static', filename='masonry.js') }}"></script>
{% endblock content %}
