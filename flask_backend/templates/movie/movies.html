{% extends 'base.html' %} {% block header %}
<style>
  .main-grid {
    column-count: 4;
    column-gap: 10px ;
    max-width: 100%;

  }

  .grid-img {
    display: grid;
    grid-template-rows: 1fr auto;
    width: 100%;
    height: auto;
    background: rgb(35, 35, 35);
    border-radius: 2px;
    margin-bottom: 10px;
  }
</style>

<script>
  async function intersectionCallback(entries, observer) {
    const entry = entries[0];
    if (entries[0].intersectionRatio <= 0) {
      return
    }

    const masonry = document.querySelector(".main-grid");


    observer.unobserve(entry.target)

    const page = masonry.getAttribute('data-page')
    let pageIncremented = parseInt(page) + 1;

    let nextPageFetch = await fetch(`/movies/posters?page=${pageIncremented}`)

    if (!nextPageFetch.ok)
      return

    let nextPageHtml = await nextPageFetch.text()
    const parser = new DOMParser()
    const doc = parser.parseFromString(nextPageHtml, 'text/html')
    const masonGrid = doc.querySelector(".main-grid")

    masonry.innerHTML += masonGrid.innerHTML
    const imgsObserver = Array.from(masonry.getElementsByTagName('img'));
    masonry.setAttribute('data-page', pageIncremented)

    observer.observe(imgsObserver[imgsObserver.length - 1]);
  }

  function removeOnError(e) {
    e.target.remove()
  }

  document.addEventListener("DOMContentLoaded", (event) => {
    const observer = new IntersectionObserver(intersectionCallback, {threshold: 1})
    const imgs = Array.from(document.querySelectorAll(".grid-img"));
    observer.observe(imgs[imgs.length - 1]);
  });
</script>
<h1>{% block title %}Posters{% endblock %}</h1>
<p>
  Todos os filmes que j√° passaram pelo cinemaempoa
</p>
<main class="main-grid" data-page="{{page}}">
  {% for movie in movies %}
    {% for screening in movie.screenings %}
        <img
          class="grid-img"
          src="/screening/assets/{{ screening['image'] }}"
          loading="lazy"
          onerror="removeOnError(event)"
        />
    {% endfor %}
  {% endfor %}
</main>
</div>

{% endblock %}
