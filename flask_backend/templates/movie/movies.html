{% extends "base.html" %}
<style>
    .grid-item {
        width: 325px;
    }
    
    .poster-container {
        position: relative;
        display: inline-block;
        cursor: pointer;
        width: 325px;
        overflow: visible;
        line-height: 0;
    }
    
    .poster-container img {
        width: 100%;
        height: auto;
        display: block;
        vertical-align: top;
    }
    
    .download-overlay {
        position: absolute !important;
        bottom: 10px !important;
        right: 3px !important;
        left: auto !important;
        opacity: 0;
        transition: opacity 0.3s ease;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        pointer-events: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.9);
        transform: translateX(0);
    }
    
    .poster-container:hover .download-overlay {
        opacity: 1;
    }
    
    .download-btn {
        color: #333 !important;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .download-btn:hover {
        color: #007bff;
        background: rgba(0, 0, 0, 0.1);
        transform: scale(1.1);
    }
    
    .download-btn svg {
        width: 28px;
        height: 28px;
        filter: drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 0 4px rgba(0, 0, 0, 1)) drop-shadow(0 2px 6px rgba(0, 0, 0, 0.9));
    }
</style>
{% block header %}
    <h1>
        {% block title %}
            Posters
        {% endblock title %}
    </h1>
    <p>Diferentes formas de visualizar os posters de filmes que já passaram pelo cinemaempoa.</p>
    <!-- Pills -->
    <nav class="navbar mb-3">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link active"
                   aria-current="true"
                   href="{{ url_for("movie.posters") }}">Mosaico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for("movie.posters_cubism") }}">Cubismo</a>
            </li>
        </ul>
    </nav>
{% endblock header %}
{% block content %}
    <section class="grid">
        {% include "movie/movie_posters.html" %}
    </section>
    <script>
        let masonry, observer, currPage = -1;

        async function intersectionCallback(entries, _observer) {
            const entry = entries[0];
            if (entries[0].intersectionRatio <= 0) {
                return;
            }
            const currentImage = entry.target;
            const section = document.querySelector("section.grid");

            _observer.unobserve(currentImage);
            currentImage.setAttribute("data-observed", 0);

            const nextPage = parseInt(currPage) + 1;

            const nextPageFetch = await fetch(
                `/movies/posters/images?page=${nextPage}`, {
                    headers: {
                        "X-LAZY-LOAD": "1"
                    }
                }
            )

            if (!nextPageFetch.ok) {
                if (nextPageFetch.status && nextPageFetch.status == 404) {
                    // register that someone scrolled to the bottom of the page
                    // using a goatcounter event
                    if (window.goatcounter) {
                        window.goatcounter.count({
                            path: window.location.pathname,
                            title: "Posters loaded last page",
                            event: true,
                        });
                    }
                }
                return;
            }

            currPage += 1;

            const nextPageText = await nextPageFetch.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(nextPageText, 'text/html');
            const nextPageContainers = doc.querySelectorAll(".poster-container.grid-item");

            section.setAttribute('data-page', nextPage);
            nextPageContainers.forEach((container) => section.appendChild(container));
            masonry.appended(nextPageContainers);

            const containersObserver = Array.from(section.getElementsByClassName('poster-container'));
            const lastContainer = containersObserver[containersObserver.length - 1];
            lastContainer.setAttribute("data-observed", 1);
            _observer.observe(lastContainer);
            // register that someone scrolled up to the next page
            // using a goatcounter event
            if (window.goatcounter) {
                window.goatcounter.count({
                    path: window.location.pathname,
                    title: "Posters load next page",
                    event: true,
                });
            }
        }

        function removeOnError(e) {
            const img = e.target;
            const container = img.closest('.poster-container');
            const isObserved = container.getAttribute("data-observed");
            container.remove();
            if (isObserved) {
                const containers = Array.from(document.querySelectorAll("section.grid .poster-container"));
                const lastContainer = containers[containers.length - 1];
                observer.observe(lastContainer);
                lastContainer.setAttribute("data-observed", 1);
            }
            masonry.layout();
        }


        // Função para carregar uma nova página de imagens
        async function fetchNextPage() {
            const section = document.querySelector("section.grid");
            const nextPage = parseInt(currPage) + 1;

            const nextPageFetch = await fetch(`/movies/posters/images?page=${nextPage}`, {
                headers: {
                    "X-LAZY-LOAD": "1"
                }
            });

            if (!nextPageFetch.ok) {
                return;
            }

            currPage += 1;

            const nextPageText = await nextPageFetch.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(nextPageText, 'text/html');
            const nextPageContainers = doc.querySelectorAll(".poster-container.grid-item");

            section.setAttribute('data-page', nextPage);
            nextPageContainers.forEach((container) => section.appendChild(container));
            masonry.appended(nextPageContainers);
        }

        document.addEventListener("DOMContentLoaded", async (event) => {
            const grid = document.querySelector('main');
            masonry = new Masonry(grid, {
                // options
                itemSelector: '.grid-item',
                columnWidth: 325
            });
            imagesLoaded(grid).on('progress', function() {
                masonry.layout();
            });

            // Chamada inicial para carregar as primeiras imagens
            await fetchNextPage();

            observer = new IntersectionObserver(intersectionCallback, {
                threshold: 1
            });
            const containers = Array.from(document.querySelectorAll(".poster-container.grid-item"));
            if (containers.length > 0) {
                observer.observe(containers[containers.length - 1]);
            }
        });
    </script>
    <script src="{{ url_for('static', filename='imagesLoaded.js') }}"></script>
    <script src="{{ url_for('static', filename='masonry.js') }}"></script>
{% endblock content %}
