{% extends "base.html" %}
{% block meta_tags %}
    <meta name="description"
          content="Acesse o mosaico com todos os posters dos filmes cadastrados no site.">
{% endblock meta_tags %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='poster-download-btn.css') }}">
{% endblock extra_css %}
<style>
    .grid-item {
        width: 325px;
    }

    .image-container {
        position: relative !important;
        display: inline-block !important;
        width: 325px !important;
        margin: 0 !important;
        padding: 0 !important;
        line-height: 0 !important;
        vertical-align: top !important;
        box-sizing: border-box !important;
    }

    .image-container .poster-image {
        display: block !important;
        width: 325px !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
    }
</style>
{% block header %}
    <h1>
        {% block title %}
            Posters
        {% endblock title %}
    </h1>
    <p>Diferentes formas de visualizar os posters de filmes que já passaram pelo cinemaempoa.</p>
    <!-- Pills -->
    <nav class="navbar mb-3">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link active"
                   aria-current="true"
                   href="{{ url_for("movie.posters") }}">Mosaico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for("movie.posters_cubism") }}">Cubismo</a>
            </li>
        </ul>
    </nav>
{% endblock header %}
{% block content %}
    <section class="grid">
        {% include "movie/movie_posters.html" %}
    </section>
    <script>
        let masonry, observer, currPage = 0;

        async function intersectionCallback(entries, _observer) {
            const entry = entries[0];
            if (entries[0].intersectionRatio <= 0) {
                return;
            }
            const currentImage = entry.target;
            const section = document.querySelector("section.grid");

            _observer.unobserve(currentImage);
            currentImage.setAttribute("data-observed", 0);

            const nextPage = parseInt(currPage) + 1;

            const nextPageFetch = await fetch(
                `/movies/posters/images?page=${nextPage}`, {
                    headers: {
                        "X-LAZY-LOAD": "1"
                    }
                }
            )

            if (!nextPageFetch.ok) {
                if (nextPageFetch.status && nextPageFetch.status == 404) {
                    // register that someone scrolled to the bottom of the page
                    // using a goatcounter event
                    if (window.goatcounter) {
                        window.goatcounter.count({
                            path: window.location.pathname,
                            title: "Posters loaded last page",
                            event: true,
                        });
                    }
                }
                return;
            }

            currPage += 1;

            const nextPageText = await nextPageFetch.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(nextPageText, 'text/html');
            const nextPageContainers = doc.querySelectorAll(".grid-item.image-container");

            section.setAttribute('data-page', nextPage);
            nextPageContainers.forEach((container) => section.appendChild(container));
            masonry.appended(nextPageContainers);

            const imgsObserver = Array.from(section.querySelectorAll('img.poster-image'));
            const lastImage = imgsObserver[imgsObserver.length - 1];
            if (lastImage) {
                lastImage.setAttribute("data-observed", 1);
                _observer.observe(lastImage);
            }
            // register that someone scrolled up to the next page
            // using a goatcounter event
            if (window.goatcounter) {
                window.goatcounter.count({
                    path: window.location.pathname,
                    title: "Posters load next page",
                    event: true,
                });
            }
        }

        function removeOnError(e) {
            const img = e.target;
            const container = img.closest('.image-container');
            const isObserved = img.getAttribute("data-observed");
            if (container) {
                container.remove();
            } else {
                img.remove();
            }
            if (isObserved) {
                const imgs = Array.from(document.querySelectorAll("section.grid img.poster-image"));
                if (imgs.length > 0) {
                    const lastImage = imgs[imgs.length - 1];
                    observer.observe(lastImage);
                    lastImage.setAttribute("data-observed", 1);
                }
            }
            masonry.layout();
        }

        function downloadImage(imageUrl) {
            // Se a URL é relativa, adiciona o domínio
            const fullUrl = imageUrl.startsWith('http') ? imageUrl : window.location.origin + imageUrl;

            fetch(fullUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // Extrai o nome do arquivo da URL
                    const urlParts = imageUrl.split('/');
                    const filename = urlParts[urlParts.length - 1] || 'poster.jpg';
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Erro ao baixar imagem:', error);
                    // Fallback: abre a imagem em nova aba
                    window.open(fullUrl, '_blank');
                });
        }


        // Função para carregar uma nova página de imagens
        async function fetchNextPage() {
            const section = document.querySelector("section.grid");
            const nextPage = parseInt(currPage) + 1;

            const nextPageFetch = await fetch(`/movies/posters/images?page=${nextPage}`, {
                headers: {
                    "X-LAZY-LOAD": "1"
                }
            });

            if (!nextPageFetch.ok) {
                return;
            }

            currPage += 1;

            const nextPageText = await nextPageFetch.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(nextPageText, 'text/html');
            const nextPageContainers = doc.querySelectorAll(".grid-item.image-container");

            section.setAttribute('data-page', nextPage);
            nextPageContainers.forEach((container) => section.appendChild(container));
            masonry.appended(nextPageContainers);
        }

        document.addEventListener("DOMContentLoaded", async (event) => {
            const grid = document.querySelector('main');
            masonry = new Masonry(grid, {
                // options
                itemSelector: '.grid-item',
                columnWidth: 325
            });
            imagesLoaded(grid).on('progress', function() {
                masonry.layout();
            });

            // Chamada inicial para carregar as primeiras imagens
            await fetchNextPage();

            observer = new IntersectionObserver(intersectionCallback, {
                threshold: 1
            });
            const imgs = Array.from(document.querySelectorAll("img.poster-image"));
            if (imgs.length > 0) {
                observer.observe(imgs[imgs.length - 1]);
                imgs[imgs.length - 1].setAttribute("data-observed", 1);
            }
        });
    </script>
    <script src="{{ url_for('static', filename='imagesLoaded.js') }}"></script>
    <script src="{{ url_for('static', filename='masonry.js') }}"></script>
{% endblock content %}
