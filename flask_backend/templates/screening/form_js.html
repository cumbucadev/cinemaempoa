<script>
  function removeScreening(e) {
      const screeningWrapper = document.getElementById("screenings");
      if (screeningWrapper.childElementCount == 2) return;
      e.parentElement.remove();
  }

  function getMaxFileSize(in_mb) {
      const max_file_size_bytes = {{ max_file_size }};
      if (in_mb) {
          return max_file_size_bytes / 1024 / 1024;
      }
      return max_file_size_bytes;
  };

    function toggleGenAltBtn(_input) {
        let input;
        if (!_input) {
            input = document.getElementById("movie_poster");
        } else {
            input = _input;
        }
        const genAltBtn = document.getElementById("gen-alt-btn");
        if (input.value != "") {
        genAltBtn.classList.remove("d-none");
        } else {
        genAltBtn.classList.add("d-none");
        }
    }

  function verifyFileSize(input) {
      const max_size_mb = getMaxFileSize() / 1024 / 1024;
      const fileSize = input.files[0].size;
      const errorMessage = document.getElementById("errorMessage");

      if (fileSize > getMaxFileSize(false)) {
          input.value = ''; // Limpar o campo de entrada para que o usuário possa selecionar novamente
          errorMessage.innerHTML = `O tamanho máximo permitido é ${getMaxFileSize(true)}MB. Por favor, selecione um arquivo menor.`;
      } else {
          errorMessage.innerHTML = '';
      }
      toggleGenAltBtn(input);
  }

  function createSimilarMovieTitleOption(movie) {
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.type = "button";
      const option_class_list = ["btn", "btn-link","link-light"]
      btn.classList.add(...option_class_list);
      btn.addEventListener("click", function () {
          document.getElementById('title').value = movie.title;
      })
      btn.textContent = movie.title;
      li.appendChild(btn);
      return li;
  }

  function fetchSimilarTitles() {
      const userInput = document.getElementById('title').value;
      const url = '/movies/search?title='
      const similarMovieDiv = document.getElementById('similar_movies');

      function clearMoviesDisplay() {
          similarMovieDiv.innerHTML = '';
      }

      if (userInput.length > 2) {
          fetch(`${url}${encodeURIComponent(userInput)}`)
          .then(response => response.json())
          .then(data => {
              clearMoviesDisplay()
              data.forEach(movie => {
                  let optionMovieTitle = createSimilarMovieTitleOption(movie)
                  similarMovieDiv.appendChild(optionMovieTitle);
              })
          });
      }
      else {
          clearMoviesDisplay()
      }
  }

  async function fetchImageAltText(e) {
      const btn = e.target;

      const image_input = document.getElementById("movie_poster");
      const image_alt = document.getElementById("image_alt");

      // prevent accidental overwriting of existing
      // image alt text
      let confirmation = true;
      if (image_alt.value != "") {
          confirmation = confirm("Substituir descrição atual?");
      }
      if (!confirmation) {
          return;
      }

      const form = new FormData();
      form.append("image", image_input.files[0]);

      btn.disabled = true;
      const response = await fetch("/screening/image/describe", {
          method: "POST",
          body: form
      });
      const payload = await response.json();

      if (!response.ok) {
          alert(payload.details);
          if (payload.hasOwnProperty("info")) {
              console.log(payload.info);
          }
      }

      if (response.ok) {
          image_alt.value = payload.text;
      }

      btn.disabled = false;
  }

  async function populateImageField(image_url) {
    if (image_url === null) {
        return;
    }
    const fileInput = document.getElementById("movie_poster");
    const filename = image_url.split("/").at(-1);
    const response = await fetch(image_url);
    if (!response.ok) {
        return;
    }
    const contentType = response.headers['content-type'];
    if (contentType === null || contentType === "") {
        return;
    }
    const blob = await response.blob();
    const file = new File([blob], filename, { type: contentType, lastModified: new Date().getTime()}, 'utf-8');
    const container = new DataTransfer();
    container.items.add(file);
    fileInput.files = container.files;
  }

    window.onload = async () => {
        const description = document.getElementById("screening-description");
        description.style.height = `${description.scrollHeight}px`;
        const backBtn = document.getElementById("back-btn");
        backBtn.addEventListener("click", (e) => {
            const proceed = confirm("Alterações não salvas serão perdidas. Prosseguir?");
            if (!proceed) {
                e.preventDefault();
                return;
            }
        });
        const addScreeningBtn = document.getElementById("add-screening-btn");
        addScreeningBtn.addEventListener("click", (e) => {
            const screeningWrapper = document.getElementById("screenings");
            const screeningDiv = screeningWrapper.lastElementChild;
            const newScreeningDiv = screeningDiv.cloneNode(true);
            screeningWrapper.appendChild(newScreeningDiv);
        });

        document.getElementById(
            "file-limit-label"
        ).innerHTML = `Tamanho máximo de imagem de ${getMaxFileSize(true)}mb!`;

        await populateImageField("{{ image }}");

        toggleGenAltBtn();
    };
</script>
